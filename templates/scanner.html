<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Scanning Center</title>
    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

    <style>
        /* General Styling */
        body { font-family: 'Inter', sans-serif; padding: 0; margin: 0; background-color: #f4f4f4; }
        .page-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .menu-button {
            display: block; width: 100%; padding: 30px 20px; font-size: 24px;
            margin: 15px 0; border: none; cursor: pointer; color: white;
            border-radius: 8px; transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .menu-button:hover { box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); }

        .blue { background-color: #3b82f6; } /* Search Order */
        .green { background-color: #10b981; } /* Dispatch */
        .red { background-color: #ef4444; } /* Return */

        .hidden { display: none !important; }

        /* Table Styling */
        .table-container { text-align: left; padding-top: 20px; }
        table {
            width: 100%; border-collapse: collapse; margin-top: 15px;
            border-radius: 8px; overflow: hidden; /* For rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        th { background-color: #374151; color: white; padding: 12px 10px; font-size: 14px; }
        td { background-color: white; padding: 10px; border-bottom: 1px solid #e5e7eb; }

        .item-image { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; vertical-align: middle; margin-right: 8px; }

        /* Report row specific style */
        .report-summary-row td {
            background-color: #d1fae5; /* light green background */
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border: none;
        }

        /* --- üîë SCANNER OVERLAY STYLING (The Transparent Background Effect) --- */
        #scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Semi-transparent dark background for the "ghosted" effect */
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #scanner-content {
            width: 90%;
            max-width: 500px;
            padding: 20px;
            background: #2d3748; /* Dark background for scanner box */
            border-radius: 12px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        /* This div is the target element for the video stream */
        #scanner-view {
            width: 100%;
            max-height: 400px; /* Adjusted height for better viewing */
            margin: 15px auto;
            position: relative;
            overflow: hidden;
            background-color: #000;
            border-radius: 8px;
        }

        /* This is now the target element for the QuaggaJS view */
        #reader {
            width: 100%;
            height: 100%;
        }

        #manualEntryField {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #3b82f6; /* Highlight border when enabled */
            background-color: white; /* White background when enabled */
            color: #1a202c; /* Dark text when enabled */
            text-align: center;
        }
        /* Style for disabled input - kept for safety but should not be active */
        #manualEntryField:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
            color: #ccc;
            border: 1px solid #4a5568;
        }
    </style>
</head>
<body>

<div id="scanner-overlay" class="hidden">
    <div id="scanner-content">
        <button onclick="handleScannerBackClick()" style="background: none; border: 1px solid #fff; color: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; float: left;">‚Üê Back</button>
        <h2 id="scanViewTitle" style="margin-top: 0; padding-top: 10px; font-size: 20px;"></h2>

        <div id="scanner-view">
            <div id="reader"></div>
        </div>

        <input type="text" id="manualEntryField"
               placeholder="Enter Order or Tracking # Manually"
               onchange="handleScanInput(this.value)"
               onkeypress="if(event.key === 'Enter') { handleScanInput(this.value); }"
               >
        <p id="scanFeedback"></p>
    </div>
</div>

<div id="main-content" class="page-container">

    <div id="main-menu">
        <h1>Scan Orders</h1>
        <button class="menu-button blue" onclick="startSingleScan()">üîç Search Order</button>
        <button class="menu-button green" onclick="startBulkScan('DISPATCHED')">üöö Scan for Dispatch</button>
        <button class="menu-button red" onclick="startBulkScan('RETURNED')">‚Ü©Ô∏è Scan for Return</button>
    </div>

    <div id="single-details" class="hidden table-container">
        <button onclick="goBackToMenu()" style="margin-bottom: 20px;">‚Üê Back to Menu</button>
        <h2>Order Details</h2>
        <p><strong>Order:</strong> <span id="singleOrderNum"></span></p>
        <p><strong>Customer:</strong> <span id="singleCustomerName"></span></p>
        <h3>Items:</h3>
        <table id="singleItemsTable">
            <thead><tr><th>Image</th><th>Title</th><th>Qty</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="bulk-list" class="hidden table-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="bulkListTitle" style="margin: 0;">Dispatch List (0)</h2>
            <p style="margin: 0; font-weight: bold;">Scanned Orders: <span id="scannedOrderCount">0</span></p>
        </div>

        <div style="display: flex; justify-content: flex-start; gap: 10px; margin-bottom: 15px;">
            <button id="scanMoreBtn" class="menu-button green" style="width: 150px; padding: 10px; font-size: 16px;" onclick="resumeScanning()">Scan More</button>
            <button id="generateReportBtn" class="menu-button red" style="width: 250px; padding: 10px; font-size: 16px;" onclick="generateReport()">Generate Dispatch Report</button>
        </div>

        <table id="bulkOrdersTable">
            <thead><tr><th>Order #</th><th>Items</th><th>Total Pieces</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
    // ====================================================================
    // üí° Setup - State Variables and Sounds
    // ====================================================================
    let currentMode = null; // 'SINGLE', 'DISPATCHED', or 'RETURNED'
    let scannedOrderCache = {};
    let isScanning = false; // Tracks if the camera stream is actively running

    // Placeholder sound objects
    const successBeep = { play: () => console.log('Beep Success') };
    const errorBeep = { play: () => console.log('Beep Error') };
    const warningBeep = { play: () => console.log('Beep Warning') };

    // ====================================================================
    // üîä Utility Functions
    // ====================================================================

    function playSound(type) {
        // Implement actual sound playing here, using the placeholder above
    }

    function hideAll() {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('single-details').classList.add('hidden');
        document.getElementById('bulk-list').classList.add('hidden');
        document.getElementById('scanner-overlay').classList.add('hidden');
    }

    // ====================================================================
    // üì∏ QuaggaJS (Barcode Scanner) Logic - REPLACED HTML5-QRCODE LOGIC
    // ====================================================================

    // NEW: Function executed on successful code detection
    function onScanSuccess(result) {
        // Prevent the scanner from repeatedly detecting the same code by pausing detection
        Quagga.offDetected(onScanSuccess); 
        
        const decodedText = result.codeResult.code;
        
        // Pass the decoded text to the main handler, which will process it
        handleScanInput(decodedText, true); 
        
        // If not in SINGLE mode (where we stop the scanner), re-attach the handler after a short delay
        if (currentMode !== 'SINGLE') {
            setTimeout(() => {
                Quagga.onDetected(onScanSuccess);
            }, 500); // 500ms delay to prevent rapid-fire duplicate scans
        }
    }

    function startScanner() {
        // Check if Quagga is available (optional safety check)
        if (typeof Quagga === 'undefined') {
            document.getElementById('scanFeedback').textContent = "ERROR: Scanning library not loaded. Please enter the ID manually below.";
            return;
        }
        
        const feedbackElement = document.getElementById('scanFeedback');
        const manualEntryField = document.getElementById('manualEntryField');

        // Ensure input field is always enabled and focused when the overlay is active
        manualEntryField.disabled = false;
        manualEntryField.value = '';
        manualEntryField.focus();

        if (isScanning) {
            feedbackElement.textContent = "Camera ON. Point at a barcode or QR code, or enter the ID manually.";
            return;
        }

        feedbackElement.textContent = "Starting camera. Please grant access...";

        // 1. Initialize QuaggaJS with improved configuration
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#reader'), // Target the 'reader' div
                constraints: {
                    facingMode: "environment" // Prioritize the back camera
                },
            },
            // NEW: Locator to improve accuracy/speed
            locator: {
                patchSize: "medium", 
                halfSample: true, 
            },
            decoder: {
                // Configure the formats most common in logistics (Code 128 is key)
                readers: [
                    "code_128_reader",
                    "code_39_reader",
                    "ean_reader",
                    "i2of5_reader",
                    // "qrcode_reader" // Include this only if you must scan QR codes.
                ],
                multiple: false // We only want one code at a time
            },
            // NEW: Image processing pipeline tweaks
            singleChannel: false,
            frequency: 10,
            numOfWorkers: navigator.hardwareConcurrency || 2
        }, function(err) {
            if (err) {
                console.error("Quagga initialization error:", err);
                feedbackElement.textContent = `ERROR: Could not start camera. Please enter the ID manually below.`;
                isScanning = false;
                return;
            }
            
            // 2. Start the camera stream
            Quagga.start();
            
            // 3. Attach detection handler
            Quagga.onDetected(onScanSuccess);

            isScanning = true;
            feedbackElement.textContent = "Camera ON. Point at a barcode or QR code, or enter the ID manually.";
            manualEntryField.focus();
        });
    }

    function stopScanner() {
        if (!isScanning) {
            isScanning = false;
            return;
        }

        try {
            // Stop Quagga and remove any event handlers
            Quagga.stop();
            isScanning = false;
            document.getElementById('scanFeedback').textContent = "Scanner stopped.";
            
            // Clear the visual artifacts left by the video stream
            document.getElementById('reader').innerHTML = '';
        } catch (e) {
            console.warn("Quagga stop error (may be harmless if already stopped):", e);
        }
    }

    // ====================================================================
    // ‚Ü©Ô∏è Navigation and Flow Control
    // ====================================================================

    function handleScannerBackClick() {
        if (currentMode === 'DISPATCHED' || currentMode === 'RETURNED') {
            openBulkList();
        } else {
            goBackToMenu();
        }
    }

    function goBackToMenu() {
        stopScanner();
        hideAll();
        document.getElementById('main-menu').classList.remove('hidden');

        // Reset state
        currentMode = null;
        scannedOrderCache = {};
        document.getElementById('bulkOrdersTable').getElementsByTagName('tbody')[0].innerHTML = '';
        document.getElementById('scannedOrderCount').textContent = '0';

        // Reset buttons for future use
        document.getElementById('generateReportBtn').classList.remove('hidden');
        document.getElementById('scanMoreBtn').classList.remove('hidden');
        document.getElementById('scanMoreBtn').disabled = false;
    }

    function startSingleScan() {
        hideAll();
        currentMode = 'SINGLE';

        document.getElementById('scanner-overlay').classList.remove('hidden');

        document.getElementById('scanViewTitle').textContent = 'Search Order';
        document.getElementById('manualEntryField').value = '';

        startScanner();
    }

    function startBulkScan(mode) {
        hideAll();
        currentMode = mode;
        const title = mode === 'DISPATCHED' ? 'Dispatch List' : 'Return List';

        // 1. Show the bulk list (as the transparent background)
        document.getElementById('bulk-list').classList.remove('hidden');
        document.getElementById('bulkListTitle').textContent = `${title} (0)`;
        document.getElementById('generateReportBtn').textContent = `Generate ${title} Report`;

        // Ensure table is empty on start of a new bulk scan
        document.getElementById('bulkOrdersTable').getElementsByTagName('tbody')[0].innerHTML = '';

        // 2. Show the scanner OVERLAY (on top)
        document.getElementById('scanViewTitle').textContent = `Scan for ${title}`;
        document.getElementById('scanner-overlay').classList.remove('hidden');

        document.getElementById('manualEntryField').value = '';
        document.getElementById('scanFeedback').textContent = 'Scan your first order, or type the ID.';

        // Ensure "Scan More" button is hidden when the scanner is active
        document.getElementById('scanMoreBtn').classList.add('hidden');
        document.getElementById('scanMoreBtn').disabled = false;

        startScanner();
    }

    // Transitions from Scanner (Overlay) to List (Background becomes main focus)
    function openBulkList() {
        stopScanner();

        // Simply hide the scanner overlay, leaving the bulk list visible underneath
        document.getElementById('scanner-overlay').classList.add('hidden');

        // Show the 'Scan More' button now that the scanner is closed
        document.getElementById('scanMoreBtn').classList.remove('hidden');

        const count = Object.keys(scannedOrderCache).length;
        document.getElementById('bulkListTitle').textContent = `${currentMode === 'DISPATCHED' ? 'Dispatch' : 'Return'} List (${count})`;
        document.getElementById('generateReportBtn').disabled = count === 0;
    }

    // Re-opens scanner view from the bulk list
    function resumeScanning() {
        // Show the overlay again and restart the camera
        document.getElementById('scanner-overlay').classList.remove('hidden');
        document.getElementById('manualEntryField').value = '';

        document.getElementById('scanFeedback').textContent = `Ready to scan more orders for ${currentMode}, or type manually.`;

        // Hide "Scan More" button while scanning is active
        document.getElementById('scanMoreBtn').classList.add('hidden');

        startScanner();
    }


    // ====================================================================
    // ‚ö° Master Handler: Called by manual input OR QuaggaJS
    // ====================================================================

    // Added optional wasCameraScan flag (defaults to false for manual input)
    async function handleScanInput(scanInput, wasCameraScan = false) {
        const manualEntryField = document.getElementById('manualEntryField');

        if (!wasCameraScan) {
            // Only clear the input field if the user typed it manually
            manualEntryField.value = '';
        }

        const orderNum = scanInput.trim().replace("#", "");
        const feedbackElement = document.getElementById('scanFeedback');


        if (!orderNum) {
            feedbackElement.textContent = 'Invalid scan/entry. Please retry.';
            manualEntryField.focus();
            
            // Re-enable detection if Quagga.offDetected was called by a false read
            if (wasCameraScan && currentMode !== 'SINGLE') {
                Quagga.onDetected(onScanSuccess);
            }
            return;
        }

        feedbackElement.textContent = `Searching for ${orderNum}...`;

        // If it was a camera scan in SINGLE mode, we stop the scanner immediately after the read.
        if (currentMode === 'SINGLE' && wasCameraScan) {
            stopScanner(); // Quagga.stop() is synchronous
        }

        // 1. Check for Duplicate (Bulk Mode Only)
        if (currentMode !== 'SINGLE' && scannedOrderCache.hasOwnProperty(orderNum)) {
            playSound('warning');
            feedbackElement.textContent = `WARNING: Order ${orderNum} already in the list. Scan next or type a new ID.`;
            manualEntryField.focus();
            
            // Re-enable detection if Quagga.offDetected was called in onScanSuccess
            if (wasCameraScan && currentMode !== 'SINGLE') {
                Quagga.onDetected(onScanSuccess);
            }
            return;
        }

        // 2. Call API Lookup (using the corrected payload from previous iteration)
        try {
            const response = await fetch('/api/scan/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scan_input: orderNum })
            });

            const data = await response.json();

            if (response.ok) {
                playSound('success');
                feedbackElement.textContent = `SUCCESS: Order ${data.order_num} added. Scan next or click 'Back'.`;

                if (currentMode === 'SINGLE') {
                    // Single scan mode displays details and closes the scanner overlay
                    document.getElementById('scanner-overlay').classList.add('hidden');
                    displaySingleOrderDetails(data);
                } else {
                    // Bulk scan mode adds to the list and keeps the scanner open
                    addOrderToBulkTable(orderNum, data);
                    manualEntryField.focus();
                }
            } else {
                playSound('error');
                // Display the specific error from the server
                feedbackElement.textContent = `ERROR: ${data.error || 'Unknown server error'}. Please retry or try a different ID.`;
                manualEntryField.focus();
                
                // Re-enable detection if Quagga.offDetected was called in onScanSuccess
                if (wasCameraScan && currentMode !== 'SINGLE') {
                    Quagga.onDetected(onScanSuccess);
                }
            }
        } catch (error) {
            playSound('error');
            // Enhanced error message for network issues
            feedbackElement.textContent = `NETWORK ERROR: Could not connect to server. Check network/server status.`;
            console.error("API Fetch failed:", error);
            manualEntryField.focus();

            // Re-enable detection if Quagga.offDetected was called in onScanSuccess
            if (wasCameraScan && currentMode !== 'SINGLE') {
                Quagga.onDetected(onScanSuccess);
            }
        }
    }

    // ====================================================================
    // üîÑ List Management
    // ====================================================================

    function displaySingleOrderDetails(data) {
        // Assumes scanner overlay is already hidden
        hideAll(); // hides everything else
        document.getElementById('single-details').classList.remove('hidden');
        document.getElementById('singleOrderNum').textContent = data.order_num;
        document.getElementById('singleCustomerName').textContent = data.customer;

        const tbody = document.getElementById('singleItemsTable').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        data.items.forEach(item => {
            const row = tbody.insertRow();
            row.insertCell(0).innerHTML = `<img src="${item.image_src || 'https://placehold.co/40x40/94a3b8/ffffff?text=No+Img'}" class="item-image" alt="Item">`;
            row.insertCell(1).textContent = item.title;
            row.insertCell(2).textContent = item.quantity;
        });
    }


    function addOrderToBulkTable(orderNum, data) {
        const numericShopifyId = data.order_id;

        let totalPieces = 0;
        data.items.forEach(item => totalPieces += item.quantity);

        // Store in cache
        scannedOrderCache[orderNum] = { id: numericShopifyId, items: data.items, pieces: totalPieces };

        const tbody = document.getElementById('bulkOrdersTable').getElementsByTagName('tbody')[0];

        // Ensure one row per unique order
        let existingRow = document.getElementById(`bulk-row-${orderNum}`);
        let row;

        if (existingRow) {
            row = existingRow;
            row.innerHTML = ''; // Clear existing cells if updating
        } else {
            // Insert a NEW row at the top (0 index)
            row = tbody.insertRow(0);
            row.id = `bulk-row-${orderNum}`;
        }

        // 1. Order # Cell
        row.insertCell(0).textContent = orderNum;

        // 2. Items Cell (Consolidated List)
        const itemsCell = row.insertCell(1);
        let itemsHTML = '';
        data.items.forEach(item => {
            itemsHTML += `
                <div style="display: flex; align-items: center; margin-bottom: 5px; font-size: 14px;">
                    <img src="${item.image_src || 'https://placehold.co/40x40/94a3b8/ffffff?text=No+Img'}" class="item-image" alt="Item">
                    ${item.title} (x${item.quantity})
                </div>
            `;
        });
        itemsCell.innerHTML = itemsHTML;

        // 3. Total Pieces Cell
        row.insertCell(2).textContent = totalPieces;

        // Update counts and title
        const count = Object.keys(scannedOrderCache).length;
        document.getElementById('scannedOrderCount').textContent = count;
        document.getElementById('bulkListTitle').textContent = `${currentMode === 'DISPATCHED' ? 'Dispatch' : 'Return'} List (${count})`;
        document.getElementById('generateReportBtn').disabled = count === 0;
    }


    // 4. Generate Report Logic
    async function generateReport() {
        const orderIds = Object.values(scannedOrderCache).map(o => o.id);
        const reportBtn = document.getElementById('generateReportBtn');
        const scanMoreBtn = document.getElementById('scanMoreBtn');
        const bulkListTitle = document.getElementById('bulkListTitle');
        const count = orderIds.length;
        const tagType = currentMode === 'RETURNED' ? 'RETURNED' : 'DISPATCHED';
        const tagTitle = currentMode === 'DISPATCHED' ? 'Dispatch' : 'Return';
        const tbody = document.getElementById('bulkOrdersTable').getElementsByTagName('tbody')[0];

        if (count === 0) return;

        reportBtn.disabled = true;
        reportBtn.textContent = 'Processing...';

        try {
            const response = await fetch('/api/apply_bulk_tag', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    order_ids: orderIds,
                    tag_type: tagType
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                playSound('success');

                // 1. Update Title and Button
                bulkListTitle.textContent = `${tagTitle} Report Generated!`;
                reportBtn.textContent = 'Report Generated (Done)';

                // 2. Clear Report button but keep the list visible
                reportBtn.classList.add('hidden');

                // 3. Disable and visually update Scan More button
                scanMoreBtn.disabled = true;
                scanMoreBtn.textContent = 'Report Processed';

                // 4. Add a visual confirmation row at the top of the table
                const date = new Date().toLocaleDateString();
                const confirmationRow = tbody.insertRow(0);
                confirmationRow.className = 'report-summary-row';

                // We span all three columns
                const cell = confirmationRow.insertCell(0);
                cell.colSpan = 3;
                cell.innerHTML = `‚úÖ **${tagType}** tag applied to **${count}** orders successfully. (${date})`;

            } else {
                playSound('error');
                console.error(`ERROR: Failed to apply tags. ${data.error || 'Server error.'}`);
                reportBtn.textContent = `Generate ${tagTitle} Report (Failed)`;
                reportBtn.disabled = false;
            }
        } catch (error) {
            playSound('error');
            console.error('API Error: Could not connect to server during bulk processing.', error);
            reportBtn.textContent = `Generate ${tagTitle} Report (Failed)`;
            reportBtn.disabled = false;
        }
    }
</script>
</body>
</html>
