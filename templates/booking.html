<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>PostEx Bulk Booking</title>
    <link href="static/assets/css/sb-admin-2.min.css" rel="stylesheet">
    <link href="static/assets/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
    <style>
        .table td, .table th { vertical-align: middle; }
        .success-row { background-color: #d4edda !important; }
        .error-row { background-color: #f8d7da !important; }
    </style>
</head>
<body id="page-top" class="p-4">

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Create Booking with PostEx</h6>
        <button onclick="submitBooking()" class="btn btn-primary" id="bookBtn">Confirm & Book</button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <form id="bookingForm">
                <table class="table table-bordered table-striped" width="100%" cellspacing="0">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 20px;"><input type="checkbox" id="selectAll" checked></th>
                            <th>Order #</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>Shopify City</th>
                            <th>PostEx City (Select)</th>
                            <th>COD Amount</th>
                            <th>Items</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr id="row-{{ order.order_id }}">
                            <td>
                                <input type="checkbox" class="row-check" name="selected_orders" value="{{ order.order_id }}" checked>
                            </td>
                            <td>{{ order.order_num }}</td>
                            <td>{{ order.customer_name }}</td>
                            <td>{{ order.customer_phone }}</td>
                            <td style="font-size: 0.8rem;">{{ order.address }}</td>
                            <td>{{ order.shopify_city }}</td>
                            <td>
                               <select class="form-control city-select" name="city_{{ order.order_id }}">

    <option value="" disabled {% if not order.matched_city %}selected{% endif %}>Select City</option>

    {% for city in postex_cities %}
        <option value="{{ city }}" {% if city == order.matched_city %}selected{% endif %}>{{ city }}</option>
    {% endfor %}
</select>
                            </td>
                            <td>
                                <input type="number" class="form-control" name="cod_{{ order.order_id }}" value="{{ order.cod_amount }}">
                            </td>
                            <td>
                                <input type="number" class="form-control" name="items_{{ order.order_id }}" value="1" readonly>
                            </td>
                            <td class="status-cell">
                                <span class="badge badge-secondary">Pending</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
        </div>
    </div>
</div>

<script src="static/assets/vendor/jquery/jquery.min.js"></script>
<script src="static/assets/vendor/jquery/jquery.min.js"></script>
<script>
    $('#selectAll').change(function() {
        $('.row-check').prop('checked', $(this).prop('checked'));
    });

    function submitBooking() {
        var btn = $('#bookBtn');
        btn.prop('disabled', true).text('Booking...');

        var payload = [];
        $('.row-check:checked').each(function() {
            var orderId = $(this).val();
            var row = $('#row-' + orderId);

            payload.push({
                order_id: orderId,
                postex_city: row.find('.city-select').val(),
                cod_amount: row.find('input[name="cod_' + orderId + '"]').val(),
                items: 1
            });
        });

        if (payload.length === 0) {
            alert("No orders selected.");
            btn.prop('disabled', false).text('Confirm & Book');
            return;
        }

        $.ajax({
            url: '/submit_postex_booking',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ bookings: payload }),
            success: function(response) {
                var successfulTrackings = [];

                response.results.forEach(function(res) {
                    var row = $('#row-' + res.order_id);
                    var statusCell = row.find('.status-cell');

                    if (res.success) {
                        row.removeClass('table-default').addClass('success-row');
                        statusCell.html('<span class="badge badge-success">' + res.tracking + '</span>');
                        successfulTrackings.push(res.tracking);
                    } else {
                        row.removeClass('table-default').addClass('error-row');
                        statusCell.html('<span class="badge badge-danger">' + res.message + '</span>');
                    }
                });

                btn.text('Finished');

                // --- NEW: Print Logic (Chunking by 10) ---
                if (successfulTrackings.length > 0) {
                    var chunkSize = 10;
                    for (var i = 0; i < successfulTrackings.length; i += chunkSize) {
                        var chunk = successfulTrackings.slice(i, i + chunkSize);
                        var trackingStr = chunk.join(',');
                        // Open each batch in a new window
                        window.open('/print_labels?tracking_numbers=' + trackingStr, '_blank');
                    }
                }
            },
            error: function() {
                alert('Server error occurred.');
                btn.prop('disabled', false).text('Confirm & Book');
            }
        });
    }
</script>

</body>
</html>