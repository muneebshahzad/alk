<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Scanning Center</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        /* General Styling (Unchanged) */
        body { font-family: 'Inter', sans-serif; padding: 0; margin: 0; background-color: #f4f4f4; }
        .page-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .menu-button {
            display: block; width: 100%; padding: 30px 20px; font-size: 24px;
            margin: 15px 0; border: none; cursor: pointer; color: white;
            border-radius: 8px; transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .menu-button:hover { box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); }

        .blue { background-color: #3b82f6; } /* Search Order */
        .green { background-color: #10b981; } /* Dispatch */
        .red { background-color: #ef4444; } /* Return */

        .hidden { display: none !important; }

        /* Table Styling (Unchanged) */
        .table-container { text-align: left; padding-top: 20px; }
        table {
            width: 100%; border-collapse: collapse; margin-top: 15px;
            border-radius: 8px; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        th { background-color: #374151; color: white; padding: 12px 10px; font-size: 14px; }
        td { background-color: white; padding: 10px; border-bottom: 1px solid #e5e7eb; }

        .item-image { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; vertical-align: middle; margin-right: 8px; }

        .report-summary-row td {
            background-color: #d1fae5;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border: none;
        }

        /* --- SCANNER OVERLAY STYLING (Unchanged) --- */
        #scanner-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }

        #scanner-content {
            width: 90%; max-width: 500px; padding: 20px;
            background: #2d3748; border-radius: 12px;
            text-align: center; color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        /* Video element inside reader div is required for jsQR */
        #reader {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #scanner-view {
            width: 100%; max-height: 400px; margin: 15px auto;
            position: relative; overflow: hidden; background-color: #000;
            border-radius: 8px;
        }

        /* NEW: Styles for the video stream and canvas */
        video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        /* The canvas is needed for processing, but we hide it */
        canvas {
            display: none;
        }

        #manualEntryField {
            width: calc(100% - 20px); padding: 10px; margin: 10px 0;
            border-radius: 6px; border: 1px solid #3b82f6;
            background-color: white; color: #1a202c; text-align: center;
        }
    </style>
</head>
<body>

<div id="scanner-overlay" class="hidden">
    <div id="scanner-content">
        <button onclick="handleScannerBackClick()" style="background: none; border: 1px solid #fff; color: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; float: left;">‚Üê Back</button>
        <h2 id="scanViewTitle" style="margin-top: 0; padding-top: 10px; font-size: 20px;"></h2>

        <div id="scanner-view">
            <div id="reader">
                <video id="videoElement"></video>
                <canvas id="canvasElement"></canvas>
            </div>
        </div>

        <input type="text" id="manualEntryField"
               placeholder="Enter Order or Tracking # Manually"
               onchange="handleScanInput(this.value)"
               onkeypress="if(event.key === 'Enter') { handleScanInput(this.value); }"
               >
        <p id="scanFeedback"></p>
    </div>
</div>

<div id="main-content" class="page-container">

    <div id="main-menu">
        <h1>Scan Orders</h1>
        <button class="menu-button blue" onclick="startSingleScan()">üîç Search Order</button>
        <button class="menu-button green" onclick="startBulkScan('DISPATCHED')">üöö Scan for Dispatch</button>
        <button class="menu-button red" onclick="startBulkScan('RETURNED')">‚Ü©Ô∏è Scan for Return</button>
    </div>

    <div id="single-details" class="hidden table-container">
        <button onclick="goBackToMenu()" style="margin-bottom: 20px;">‚Üê Back to Menu</button>
        <h2>Order Details</h2>
        <p><strong>Order:</strong> <span id="singleOrderNum"></span></p>
        <p><strong>Customer:</strong> <span id="singleCustomerName"></span></p>
        <h3>Items:</h3>
        <table id="singleItemsTable">
            <thead><tr><th>Image</th><th>Title</th><th>Qty</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="bulk-list" class="hidden table-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="bulkListTitle" style="margin: 0;">Dispatch List (0)</h2>
            <p style="margin: 0; font-weight: bold;">Scanned Orders: <span id="scannedOrderCount">0</span></p>
        </div>

        <div style="display: flex; justify-content: flex-start; gap: 10px; margin-bottom: 15px;">
            <button id="scanMoreBtn" class="menu-button green" style="width: 150px; padding: 10px; font-size: 16px;" onclick="resumeScanning()">Scan More</button>
            <button id="generateReportBtn" class="menu-button red" style="width: 250px; padding: 10px; font-size: 16px;" onclick="generateReport()">Generate Dispatch Report</button>
        </div>

        <table id="bulkOrdersTable">
            <thead><tr><th>Order #</th><th>Items</th><th>Total Pieces</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
    // ====================================================================
    // üí° Setup - State Variables and Sounds
    // ====================================================================
    let currentMode = null;
    let scannedOrderCache = {};
    let isScanning = false;
    let videoElement = document.getElementById('videoElement');
    let canvasElement = document.getElementById('canvasElement');
    let canvasContext = canvasElement.getContext('2d', { willReadFrequently: true });
    let stream = null; // To hold the media stream reference
    let requestAnimationFrameId; // To control the decoding loop

    // Placeholder sound objects (Unchanged)
    const successBeep = { play: () => console.log('Beep Success') };
    const errorBeep = { play: () => console.log('Beep Error') };
    const warningBeep = { play: () => console.log('Beep Warning') };

    // ====================================================================
    // üîä Utility Functions (Unchanged)
    // ====================================================================

    function playSound(type) {
        // Implement actual sound playing here, using the placeholder above
    }

    function hideAll() {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('single-details').classList.add('hidden');
        document.getElementById('bulk-list').classList.add('hidden');
        document.getElementById('scanner-overlay').classList.add('hidden');
    }

    // ====================================================================
    // üì∏ jsQR (High-Performance Scanner) Logic
    // ====================================================================

    function tick() {
        if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
            // Resize canvas to video size
            canvasElement.height = videoElement.videoHeight;
            canvasElement.width = videoElement.videoWidth;

            // Draw the current video frame onto the canvas
            canvasContext.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

            // Get the image data from the canvas
            const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);

            // This is the core-jsQR call: decode the data
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                // Inversion less likely with modern labels/QR codes
                inversionAttempts: "dontInvert", 
            });

            if (code) {
                // Code detected! Stop the loop and handle the input.
                cancelAnimationFrame(requestAnimationFrameId);
                onScanSuccess(code.data);
                return; // Stop processing frame for this tick
            }
        }
        
        // Loop: Continue processing frames if a code wasn't found
        requestAnimationFrameId = requestAnimationFrame(tick);
    }

    function onScanSuccess(decodedText) {
        // Pass the decoded text to the main handler, which will process it
        handleScanInput(decodedText, true); 
        // Note: handleScanInput will restart the loop in bulk mode if needed.
    }

    function startScanner() {
        const feedbackElement = document.getElementById('scanFeedback');
        const manualEntryField = document.getElementById('manualEntryField');

        manualEntryField.disabled = false;
        manualEntryField.value = '';
        manualEntryField.focus();

        if (isScanning) {
            feedbackElement.textContent = "Camera ON. Point at a barcode or QR code, or enter the ID manually.";
            return;
        }

        feedbackElement.textContent = "Starting camera. Please grant access...";
        
        // 1. Get media stream
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(mediaStream => {
                stream = mediaStream;
                videoElement.srcObject = mediaStream;
                videoElement.setAttribute("playsinline", true); // Required for iOS
                videoElement.play();

                videoElement.onloadedmetadata = () => {
                    // 2. Start the decoding loop once video metadata is loaded
                    isScanning = true;
                    requestAnimationFrame(tick);
                    feedbackElement.textContent = "Camera ON. Point at a barcode or QR code, or enter the ID manually.";
                    manualEntryField.focus();
                };
            })
            .catch(err => {
                console.error("Camera access error:", err);
                feedbackElement.textContent = `ERROR: Could not start camera (${err.name}). Please enter the ID manually below.`;
                isScanning = false;
            });
    }

    function stopScanner() {
        if (!isScanning) {
            isScanning = false;
            return;
        }

        // 1. Stop the decoding loop
        cancelAnimationFrame(requestAnimationFrameId);

        // 2. Stop the video stream
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            videoElement.srcObject = null;
        }
        
        isScanning = false;
        document.getElementById('scanFeedback').textContent = "Scanner stopped.";
        
        // Clear the visual element (though less necessary with video tag)
        canvasContext.clearRect(0, 0, canvasElement.width, canvasElement.height);
    }

    // ====================================================================
    // ‚Ü©Ô∏è Navigation and Flow Control (Minor Adjustments)
    // ====================================================================

    function handleScannerBackClick() {
        if (currentMode === 'DISPATCHED' || currentMode === 'RETURNED') {
            openBulkList();
        } else {
            goBackToMenu();
        }
    }

    function goBackToMenu() {
        stopScanner();
        hideAll();
        document.getElementById('main-menu').classList.remove('hidden');

        // Reset state
        currentMode = null;
        scannedOrderCache = {};
        document.getElementById('bulkOrdersTable').getElementsByTagName('tbody')[0].innerHTML = '';
        document.getElementById('scannedOrderCount').textContent = '0';

        // Reset buttons for future use
        document.getElementById('generateReportBtn').classList.remove('hidden');
        document.getElementById('scanMoreBtn').classList.remove('hidden');
        document.getElementById('scanMoreBtn').disabled = false;
    }

    function startSingleScan() {
        hideAll();
        currentMode = 'SINGLE';
        document.getElementById('scanner-overlay').classList.remove('hidden');
        document.getElementById('scanViewTitle').textContent = 'Search Order';
        document.getElementById('manualEntryField').value = '';
        startScanner();
    }

    function startBulkScan(mode) {
        hideAll();
        currentMode = mode;
        const title = mode === 'DISPATCHED' ? 'Dispatch List' : 'Return List';

        document.getElementById('bulk-list').classList.remove('hidden');
        document.getElementById('bulkListTitle').textContent = `${title} (0)`;
        document.getElementById('generateReportBtn').textContent = `Generate ${title} Report`;
        document.getElementById('bulkOrdersTable').getElementsByTagName('tbody')[0].innerHTML = '';
        document.getElementById('scanViewTitle').textContent = `Scan for ${title}`;
        document.getElementById('scanner-overlay').classList.remove('hidden');
        document.getElementById('manualEntryField').value = '';
        document.getElementById('scanFeedback').textContent = 'Scan your first order, or type the ID.';
        document.getElementById('scanMoreBtn').classList.add('hidden');
        document.getElementById('scanMoreBtn').disabled = false;

        startScanner();
    }

    function openBulkList() {
        stopScanner();
        document.getElementById('scanner-overlay').classList.add('hidden');
        document.getElementById('scanMoreBtn').classList.remove('hidden');
        const count = Object.keys(scannedOrderCache).length;
        document.getElementById('bulkListTitle').textContent = `${currentMode === 'DISPATCHED' ? 'Dispatch' : 'Return'} List (${count})`;
        document.getElementById('generateReportBtn').disabled = count === 0;
    }

    function resumeScanning() {
        document.getElementById('scanner-overlay').classList.remove('hidden');
        document.getElementById('manualEntryField').value = '';
        document.getElementById('scanFeedback').textContent = `Ready to scan more orders for ${currentMode}, or type manually.`;
        document.getElementById('scanMoreBtn').classList.add('hidden');
        startScanner();
    }


    // ====================================================================
    // ‚ö° Master Handler: Called by manual input OR jsQR
    // ====================================================================

    async function handleScanInput(scanInput, wasCameraScan = false) {
        const manualEntryField = document.getElementById('manualEntryField');

        if (!wasCameraScan) {
            manualEntryField.value = '';
        }

        const orderNum = scanInput.trim().replace("#", "");
        const feedbackElement = document.getElementById('scanFeedback');


        if (!orderNum) {
            feedbackElement.textContent = 'Invalid scan/entry. Please retry.';
            manualEntryField.focus();
            return;
        }

        feedbackElement.textContent = `Searching for ${orderNum}...`;

        // If it was a camera scan in SINGLE mode, we stop the scanner immediately after the read.
        if (currentMode === 'SINGLE' && wasCameraScan) {
            stopScanner();
        }

        // 1. Check for Duplicate (Bulk Mode Only)
        if (currentMode !== 'SINGLE' && scannedOrderCache.hasOwnProperty(orderNum)) {
            playSound('warning');
            feedbackElement.textContent = `WARNING: Order ${orderNum} already in the list. Scan next or type a new ID.`;
            manualEntryField.focus();
            
            // Restart the scanning loop for the next item
            if (wasCameraScan && currentMode !== 'SINGLE') {
                requestAnimationFrame(tick);
            }
            return;
        }

        // 2. Call API Lookup
        try {
            const response = await fetch('/api/scan/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scan_input: orderNum })
            });

            const data = await response.json();

            if (response.ok) {
                playSound('success');
                feedbackElement.textContent = `SUCCESS: Order ${data.order_num} added. Scan next or click 'Back'.`;

                if (currentMode === 'SINGLE') {
                    document.getElementById('scanner-overlay').classList.add('hidden');
                    displaySingleOrderDetails(data);
                } else {
                    addOrderToBulkTable(orderNum, data);
                    manualEntryField.focus();
                    
                    // Restart the scanning loop for the next item
                    requestAnimationFrame(tick);
                }
            } else {
                playSound('error');
                feedbackElement.textContent = `ERROR: ${data.error || 'Unknown server error'}. Please retry or try a different ID.`;
                manualEntryField.focus();
                
                // Restart the scanning loop for the next item
                if (wasCameraScan && currentMode !== 'SINGLE') {
                    requestAnimationFrame(tick);
                }
            }
        } catch (error) {
            playSound('error');
            feedbackElement.textContent = `NETWORK ERROR: Could not connect to server. Check your network connection and server status.`;
            console.error("API Fetch failed:", error);
            manualEntryField.focus();

            // Restart the scanning loop
            if (wasCameraScan && currentMode !== 'SINGLE') {
                requestAnimationFrame(tick);
            }
        }
    }

    // ====================================================================
    // üîÑ List Management (Unchanged)
    // ====================================================================

    function displaySingleOrderDetails(data) {
        hideAll();
        document.getElementById('single-details').classList.remove('hidden');
        document.getElementById('singleOrderNum').textContent = data.order_num;
        document.getElementById('singleCustomerName').textContent = data.customer;

        const tbody = document.getElementById('singleItemsTable').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        data.items.forEach(item => {
            const row = tbody.insertRow();
            row.insertCell(0).innerHTML = `<img src="${item.image_src || 'https://placehold.co/40x40/94a3b8/ffffff?text=No+Img'}" class="item-image" alt="Item">`;
            row.insertCell(1).textContent = item.title;
            row.insertCell(2).textContent = item.quantity;
        });
    }


    function addOrderToBulkTable(orderNum, data) {
        const numericShopifyId = data.order_id;

        let totalPieces = 0;
        data.items.forEach(item => totalPieces += item.quantity);

        scannedOrderCache[orderNum] = { id: numericShopifyId, items: data.items, pieces: totalPieces };

        const tbody = document.getElementById('bulkOrdersTable').getElementsByTagName('tbody')[0];

        let existingRow = document.getElementById(`bulk-row-${orderNum}`);
        let row;

        if (existingRow) {
            row = existingRow;
            row.innerHTML = '';
        } else {
            row = tbody.insertRow(0);
            row.id = `bulk-row-${orderNum}`;
        }

        row.insertCell(0).textContent = orderNum;

        const itemsCell = row.insertCell(1);
        let itemsHTML = '';
        data.items.forEach(item => {
            itemsHTML += `
                <div style="display: flex; align-items: center; margin-bottom: 5px; font-size: 14px;">
                    <img src="${item.image_src || 'https://placehold.co/40x40/94a3b8/ffffff?text=No+Img'}" class="item-image" alt="Item">
                    ${item.title} (x${item.quantity})
                </div>
            `;
        });
        itemsCell.innerHTML = itemsHTML;

        row.insertCell(2).textContent = totalPieces;

        const count = Object.keys(scannedOrderCache).length;
        document.getElementById('scannedOrderCount').textContent = count;
        document.getElementById('bulkListTitle').textContent = `${currentMode === 'DISPATCHED' ? 'Dispatch' : 'Return'} List (${count})`;
        document.getElementById('generateReportBtn').disabled = count === 0;
    }


    // 4. Generate Report Logic (Unchanged)
    async function generateReport() {
        const orderIds = Object.values(scannedOrderCache).map(o => o.id);
        const reportBtn = document.getElementById('generateReportBtn');
        const scanMoreBtn = document.getElementById('scanMoreBtn');
        const bulkListTitle = document.getElementById('bulkListTitle');
        const count = orderIds.length;
        const tagType = currentMode === 'RETURNED' ? 'RETURNED' : 'DISPATCHED';
        const tagTitle = currentMode === 'DISPATCHED' ? 'Dispatch' : 'Return';
        const tbody = document.getElementById('bulkOrdersTable').getElementsByTagName('tbody')[0];

        if (count === 0) return;

        reportBtn.disabled = true;
        reportBtn.textContent = 'Processing...';

        try {
            const response = await fetch('/api/apply_bulk_tag', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    order_ids: orderIds,
                    tag_type: tagType
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                playSound('success');

                bulkListTitle.textContent = `${tagTitle} Report Generated!`;
                reportBtn.textContent = 'Report Generated (Done)';
                reportBtn.classList.add('hidden');
                scanMoreBtn.disabled = true;
                scanMoreBtn.textContent = 'Report Processed';

                const date = new Date().toLocaleDateString();
                const confirmationRow = tbody.insertRow(0);
                confirmationRow.className = 'report-summary-row';

                const cell = confirmationRow.insertCell(0);
                cell.colSpan = 3;
                cell.innerHTML = `‚úÖ **${tagType}** tag applied to **${count}** orders successfully. (${date})`;

            } else {
                playSound('error');
                console.error(`ERROR: Failed to apply tags. ${data.error || 'Server error.'}`);
                reportBtn.textContent = `Generate ${tagTitle} Report (Failed)`;
                reportBtn.disabled = false;
            }
        } catch (error) {
            playSound('error');
            console.error('API Error: Could not connect to server during bulk processing.', error);
            reportBtn.textContent = `Generate ${tagTitle} Report (Failed)`;
            reportBtn.disabled = false;
        }
    }
</script>
</body>
</html>
